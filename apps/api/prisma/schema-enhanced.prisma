// =====================================================
// BioTrakr Asset Management Database Schema
// Prisma ORM Schema with TimescaleDB Support
// Version: 2.0
// Date: November 8, 2025
// =====================================================

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
  extensions = [uuidOssp(map: "uuid-ossp"), pg_trgm, timescaledb]
}

// =====================================================
// ENUMS
// =====================================================

enum AssetStatus {
  ACTIVE
  IN_SERVICE
  IN_MAINTENANCE
  QUARANTINED
  CONDEMNED
  RETIRED
  DISPOSED
}

enum DeviceCategory {
  IMAGING
  LABORATORY
  SURGICAL
  PATIENT_MONITORING
  THERAPEUTIC
  LIFE_SUPPORT
  DIAGNOSTIC
  ANESTHESIA
  STERILIZATION
  SUPPORT_EQUIPMENT
  IT_MEDICAL
  OTHER
}

enum CriticalityLevel {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum RiskClassification {
  CLASS_I
  CLASS_II
  CLASS_III
}

enum RecallStatus {
  NONE
  CLASS_I
  CLASS_II
  CLASS_III
}

enum PMComplianceStatus {
  COMPLIANT
  GRACE_PERIOD
  OVERDUE
  CRITICAL
}

enum FailureCategory {
  ELECTRICAL
  MECHANICAL
  SOFTWARE
  HYDRAULIC
  PNEUMATIC
  SENSOR
  CALIBRATION
  USER_ERROR
  UNKNOWN
}

enum DepreciationMethod {
  STRAIGHT_LINE
  DECLINING_BALANCE
  DOUBLE_DECLINING
  UNITS_OF_PRODUCTION
  SUM_OF_YEARS_DIGITS
}

enum SyncStatus {
  SYNCED
  PENDING
  FAILED
  NOT_CONFIGURED
}

enum ServiceLevel {
  TWO_HOURS
  FOUR_HOURS
  EIGHT_HOURS
  TWENTY_FOUR_HOURS
  NEXT_DAY
  BEST_EFFORT
}

enum WasteHandling {
  STANDARD
  BIOHAZARD
  RADIOACTIVE
  CHEMICAL
  SHARPS
  PHARMACEUTICAL
}

enum AlertSeverity {
  INFO
  WARNING
  ERROR
  CRITICAL
}

enum WorkOrderStatus {
  PENDING
  ASSIGNED
  IN_PROGRESS
  AWAITING_PARTS
  ON_HOLD
  COMPLETED
  CANCELLED
}

enum WorkOrderType {
  PREVENTIVE_MAINTENANCE
  CORRECTIVE_MAINTENANCE
  CALIBRATION
  INSPECTION
  EMERGENCY_REPAIR
  INSTALLATION
  DECOMMISSIONING
}

enum VendorType {
  MANUFACTURER
  DISTRIBUTOR
  SERVICE_PROVIDER
  PARTS_SUPPLIER
}

enum TrackingMethod {
  RFID
  BLE
  QR
  GPS
  MANUAL
  NFC
}

// =====================================================
// MASTER DATA MODELS
// =====================================================

model Organization {
  id        String   @id @default(uuid())
  name      String
  type      String
  settings  Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  facilities Facility[]
  users      User[]
  assets     Asset[]

  @@map("organizations")
}

model Facility {
  id             String   @id @default(uuid())
  organizationId String
  facilityCode   String   @unique
  facilityName   String
  facilityType   String?
  addressLine1   String?
  addressLine2   String?
  city           String?
  stateProvince  String?
  postalCode     String?
  country        String?
  phone          String?
  email          String?
  licenseNumber  String?
  accreditationBody String?
  timezone       String   @default("UTC")
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  buildings    Building[]
  departments  Department[]
  assets       Asset[] @relation("AssetCurrentFacility")
  locationHistory LocationHistory[]
  transfersFrom   TransferHistory[] @relation("TransferFrom")
  transfersTo     TransferHistory[] @relation("TransferTo")

  @@index([organizationId])
  @@map("facilities")
}

model Building {
  id             String   @id @default(uuid())
  facilityId     String
  buildingCode   String
  buildingName   String
  floorCount     Int?
  gpsLatitude    Decimal? @db.Decimal(10, 7)
  gpsLongitude   Decimal? @db.Decimal(10, 7)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  facility Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  floors   Floor[]
  assets   Asset[] @relation("AssetCurrentBuilding")
  locationHistory LocationHistory[]

  @@unique([facilityId, buildingCode])
  @@index([facilityId])
  @@map("buildings")
}

model Floor {
  id                     String   @id @default(uuid())
  buildingId             String
  floorNumber            Int
  floorName              String?
  floorPlanImageUrl      String?
  floorPlanScaleMetersPerPixel Decimal? @db.Decimal(6, 4)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  building Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)
  rooms    Room[]
  assets   Asset[] @relation("AssetCurrentFloor")
  locationHistory LocationHistory[]

  @@unique([buildingId, floorNumber])
  @@index([buildingId])
  @@map("floors")
}

model Room {
  id              String   @id @default(uuid())
  floorId         String
  roomCode        String
  roomName        String
  roomType        String?
  areaSquareMeters Decimal? @db.Decimal(8, 2)
  capacityBeds    Int?
  isRestricted    Boolean  @default(false)
  geofencePolygon Json?
  centerX         Decimal? @db.Decimal(10, 4)
  centerY         Decimal? @db.Decimal(10, 4)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  floor       Floor    @relation(fields: [floorId], references: [id], onDelete: Cascade)
  assets      Asset[] @relation("AssetCurrentRoom")
  homeAssets  Asset[] @relation("AssetHomeLocation")
  locationHistory LocationHistory[]
  transfersFrom   TransferHistory[] @relation("TransferFromRoom")
  transfersTo     TransferHistory[] @relation("TransferToRoom")
  assignmentHistory AssignmentHistory[]

  @@unique([floorId, roomCode])
  @@index([floorId])
  @@map("rooms")
}

model Department {
  id               String   @id @default(uuid())
  facilityId       String
  departmentCode   String
  departmentName   String
  parentDepartmentId String?
  costCenter       String?
  managerUserId    String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  facility         Facility     @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  parentDepartment Department?  @relation("DepartmentHierarchy", fields: [parentDepartmentId], references: [id])
  childDepartments Department[] @relation("DepartmentHierarchy")
  manager          User?        @relation("DepartmentManager", fields: [managerUserId], references: [id])
  employees        User[]       @relation("UserDepartment")
  assets           Asset[] @relation("AssetDepartment")
  custodianAssets  Asset[] @relation("AssetCustodianDepartment")
  usageLogs        UsageLog[]
  assignmentHistory AssignmentHistory[]

  @@unique([facilityId, departmentCode])
  @@index([facilityId])
  @@index([managerUserId])
  @@map("departments")
}

model User {
  id                    String    @id @default(uuid())
  organizationId        String
  username              String    @unique
  email                 String    @unique
  passwordHash          String?
  firstName             String
  lastName              String
  phone                 String?
  employeeId            String?
  jobTitle              String?
  departmentId          String?
  facilityId            String?
  role                  String
  isActive              Boolean   @default(true)
  lastLoginAt           DateTime?
  failedLoginAttempts   Int       @default(0)
  accountLockedUntil    DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department           Department?  @relation("UserDepartment", fields: [departmentId], references: [id])
  managedDepartments   Department[] @relation("DepartmentManager")
  
  // Asset relationships
  custodianAssets           Asset[] @relation("AssetCustodian")
  currentlyAssignedAssets   Asset[] @relation("AssetCurrentAssignedUser")
  currentOperatorAssets     Asset[] @relation("AssetCurrentOperator")
  lastOperatorAssets        Asset[] @relation("AssetLastOperator")
  assetsCreated             Asset[] @relation("AssetCreatedBy")
  assetsUpdated             Asset[] @relation("AssetUpdatedBy")
  assetsDeleted             Asset[] @relation("AssetDeletedBy")
  
  // Maintenance relationships
  assignedMaintenanceTasks  MaintenanceHistory[] @relation("MaintenanceAssignedTechnician")
  createdMaintenanceTasks   MaintenanceHistory[] @relation("MaintenanceCreatedBy")
  
  // Other relationships
  usageLogs                 UsageLog[]
  locationHistoryRecorded   LocationHistory[]
  complianceEventsCreated   ComplianceEvent[]
  alertsAcknowledged        AlertHistory[] @relation("AlertAcknowledgedBy")
  alertsResolved            AlertHistory[] @relation("AlertResolvedBy")
  alertsEscalated           AlertHistory[] @relation("AlertEscalatedTo")
  assignmentsAssigned       AssignmentHistory[] @relation("AssignedBy")
  assignmentsReceived       AssignmentHistory[] @relation("AssignedTo")
  transfersInitiated        TransferHistory[] @relation("TransferInitiated")
  transfersApproved         TransferHistory[] @relation("TransferApproved")
  transfersReceived         TransferHistory[] @relation("TransferReceived")
  trainingRecords           TrainingRecord[]
  mediaUploaded             MediaAttachment[]

  @@index([organizationId])
  @@index([email])
  @@index([facilityId])
  @@index([departmentId])
  @@map("users")
}

model Vendor {
  id                   String       @id @default(uuid())
  vendorCode           String       @unique
  vendorName           String
  vendorType           VendorType
  contactPerson        String?
  phone                String?
  email                String?
  website              String?
  address              String?
  taxId                String?
  paymentTerms         String?
  serviceResponseTime  ServiceLevel?
  isActive             Boolean      @default(true)
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  assetsSupplied       Asset[] @relation("AssetVendor")
  assetsWithAMC        Asset[] @relation("AssetAMCProvider")
  assetsWithCMC        Asset[] @relation("AssetCMCProvider")
  maintenanceHistory   MaintenanceHistory[]
  spareParts           SparePart[]

  @@map("vendors")
}

// =====================================================
// MAIN ASSET MODEL
// =====================================================

model Asset {
  id                              String              @id @default(uuid())
  organizationId                  String
  
  // === BASIC IDENTIFICATION ===
  assetTagNumber                  String              @unique
  equipmentName                   String
  manufacturer                    String
  modelNumber                     String
  serialNumber                    String
  deviceCategory                  DeviceCategory
  deviceSubcategory               String?
  
  // UDI (FDA Requirement)
  udiDeviceIdentifier             String?
  udiProductionIdentifier         String?
  gmdnCode                        String?
  
  // Status
  assetStatus                     AssetStatus         @default(ACTIVE)
  criticalityLevel                CriticalityLevel
  
  // === PROCUREMENT ===
  vendorId                        String?
  purchaseOrderNumber             String?
  invoiceNumber                   String?
  purchaseDate                    DateTime
  installationDate                DateTime?
  purchaseCost                    Decimal             @db.Decimal(12, 2)
  currencyCode                    String              @default("USD")
  fundingSource                   String?
  grantNumber                     String?
  estimatedReplacementCost        Decimal?            @db.Decimal(12, 2)
  residualValue                   Decimal?            @db.Decimal(12, 2)
  
  // === WARRANTY & CONTRACTS ===
  warrantyStartDate               DateTime?
  warrantyEndDate                 DateTime?
  warrantyTerms                   String?
  amcProviderId                   String?
  amcContractNumber               String?
  amcStartDate                    DateTime?
  amcEndDate                      DateTime?
  amcCostAnnual                   Decimal?            @db.Decimal(12, 2)
  cmcProviderId                   String?
  serviceLevelAgreement           ServiceLevel?
  
  // === TECHNICAL SPECIFICATIONS ===
  technicalSpecifications         Json?
  softwareVersion                 String?
  operatingSystem                 String?
  networkMacAddress               String?
  ipAddress                       String?
  powerRequirements               String?
  weightKg                        Decimal?            @db.Decimal(8, 2)
  dimensionsCm                    String?
  requiresCalibration             Boolean             @default(false)
  calibrationFrequencyDays        Int?
  lastCalibrationDate             DateTime?
  nextCalibrationDue              DateTime?
  environmentalRequirements       String?
  
  // === REGULATORY & COMPLIANCE ===
  riskClassification              RiskClassification
  fdaRegistrationNumber           String?
  fda510kNumber                   String?
  ceMarkCertificate               String?
  isoCertification                String?
  recallStatus                    RecallStatus        @default(NONE)
  recallNoticeId                  String?
  lastSafetyInspectionDate        DateTime?
  nextSafetyInspectionDue         DateTime?
  biomedicalWasteHandling         WasteHandling?
  requiresOperatorCertification   Boolean             @default(false)
  decontaminationProtocol         String?
  
  // === PREVENTIVE MAINTENANCE ===
  pmFrequencyDays                 Int?
  lastPmDate                      DateTime?
  nextPmDueDate                   DateTime?
  pmProcedureDocument             String?
  pmEstimatedDurationHours        Decimal?            @db.Decimal(4, 1)
  autoGenerateWorkOrders          Boolean             @default(true)
  pmComplianceStatus              PMComplianceStatus  @default(COMPLIANT)
  
  // === REAL-TIME LOCATION TRACKING ===
  currentFacilityId               String
  currentBuildingId               String?
  currentFloorId                  String?
  currentRoomId                   String?
  currentZone                     String?
  currentCoordinatesX             Decimal?            @db.Decimal(10, 4)
  currentCoordinatesY             Decimal?            @db.Decimal(10, 4)
  currentCoordinatesZ             Decimal?            @db.Decimal(10, 4)
  locationAccuracyMeters          Decimal?            @db.Decimal(4, 2)
  lastSeenTimestamp               DateTime            @default(now())
  isMoving                        Boolean             @default(false)
  
  // Tracking Technologies
  rfidTagId                       String?
  rfidTagIds                      Json?
  bleBeaconMac                    String?
  gpsLatitude                     Decimal?            @db.Decimal(10, 7)
  gpsLongitude                    Decimal?            @db.Decimal(10, 7)
  geofenceViolations              Int                 @default(0)
  homeLocationId                  String?
  
  // === USAGE & UTILIZATION ===
  totalUsageHours                 Decimal             @default(0) @db.Decimal(12, 2)
  totalUsageCycles                BigInt              @default(0)
  currentAssignedUserId           String?
  currentAssignedDepartmentId     String?
  utilizationRatePercent          Decimal?            @db.Decimal(5, 2)
  idleTimeHoursLast30Days         Decimal             @default(0) @db.Decimal(8, 2)
  lastUsedTimestamp               DateTime?
  averageSessionDurationMinutes   Decimal?            @db.Decimal(8, 2)
  peakUsageDayOfWeek              String?
  peakUsageHourOfDay              Int?
  
  // === PREDICTIVE MAINTENANCE ===
  failureProbabilityScore         Decimal?            @db.Decimal(5, 2)
  predictedFailureDate            DateTime?
  failureCategory                 FailureCategory?
  mtbfHours                       Decimal?            @db.Decimal(12, 2)
  mttrHours                       Decimal?            @db.Decimal(8, 2)
  failureCountLifetime            Int                 @default(0)
  lastFailureDate                 DateTime?
  mlModelVersion                  String?
  mlPredictionConfidence          Decimal?            @db.Decimal(5, 2)
  mlLastAnalyzedTimestamp         DateTime?
  iotSensorEnabled                Boolean             @default(false)
  iotSensorIds                    Json?
  
  // === FINANCIAL & DEPRECIATION ===
  depreciationMethod              DepreciationMethod  @default(STRAIGHT_LINE)
  usefulLifeYears                 Int
  salvageValue                    Decimal             @default(0) @db.Decimal(12, 2)
  currentBookValue                Decimal?            @db.Decimal(12, 2)
  accumulatedDepreciation         Decimal             @default(0) @db.Decimal(12, 2)
  totalMaintenanceCostLifetime    Decimal             @default(0) @db.Decimal(12, 2)
  totalDowntimeHoursLifetime      Decimal             @default(0) @db.Decimal(12, 2)
  downtimeCostPerHour             Decimal             @default(0) @db.Decimal(10, 2)
  totalCostOfOwnership            Decimal?            @db.Decimal(12, 2)
  roiCalculation                  Decimal?            @db.Decimal(10, 2)
  
  // === USER ASSIGNMENT ===
  primaryCustodianId              String
  custodianDepartmentId           String
  currentOperatorId               String?
  lastOperatorId                  String?
  requiresCheckout                Boolean             @default(false)
  checkedOut                      Boolean             @default(false)
  checkoutTimestamp               DateTime?
  expectedReturnTimestamp         DateTime?
  
  // === INTEGRATION & INTEROPERABILITY ===
  ehrSystemAssetId                String?
  cmmsPlatformAssetId             String?
  financialSystemAssetId          String?
  hl7FhirResourceId               String?
  externalSystemUrls              Json?
  lastEhrSyncTimestamp            DateTime?
  lastCmmsSyncTimestamp           DateTime?
  syncStatus                      SyncStatus          @default(NOT_CONFIGURED)
  
  // === ALERT CONFIGURATION ===
  pmAlertDaysBefore               Int                 @default(7)
  calibrationAlertDaysBefore      Int?
  warrantyExpiryAlertDays         Int?
  geofenceAlertEnabled            Boolean             @default(false)
  idleAlertThresholdDays          Int?
  alertRecipients                 Json?
  escalationEnabled               Boolean             @default(false)
  escalationDelayHours            Int?
  
  // === MEDIA & DOCUMENTATION ===
  photoUrl                        String?
  installationPhotoUrls           Json?
  damagePhotoUrls                 Json?
  manualDocumentUrl               String?
  serviceManualUrl                String?
  trainingVideoUrls               Json?
  qrCodeImageUrl                  String?
  attachmentStoragePath           String?
  
  // === AUDIT TRAIL ===
  createdAt                       DateTime            @default(now())
  createdById                     String
  updatedAt                       DateTime            @updatedAt
  updatedById                     String
  deletedAt                       DateTime?
  deletedById                     String?
  version                         Int                 @default(1)
  notes                           String?

  // === RELATIONSHIPS ===
  organization                    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vendor                          Vendor? @relation("AssetVendor", fields: [vendorId], references: [id])
  amcProvider                     Vendor? @relation("AssetAMCProvider", fields: [amcProviderId], references: [id])
  cmcProvider                     Vendor? @relation("AssetCMCProvider", fields: [cmcProviderId], references: [id])
  currentFacility                 Facility @relation("AssetCurrentFacility", fields: [currentFacilityId], references: [id])
  currentBuilding                 Building? @relation("AssetCurrentBuilding", fields: [currentBuildingId], references: [id])
  currentFloor                    Floor? @relation("AssetCurrentFloor", fields: [currentFloorId], references: [id])
  currentRoom                     Room? @relation("AssetCurrentRoom", fields: [currentRoomId], references: [id])
  homeLocation                    Room? @relation("AssetHomeLocation", fields: [homeLocationId], references: [id])
  currentAssignedUser             User? @relation("AssetCurrentAssignedUser", fields: [currentAssignedUserId], references: [id])
  currentAssignedDepartment       Department? @relation("AssetDepartment", fields: [currentAssignedDepartmentId], references: [id])
  custodian                       User @relation("AssetCustodian", fields: [primaryCustodianId], references: [id])
  custodianDepartment             Department @relation("AssetCustodianDepartment", fields: [custodianDepartmentId], references: [id])
  currentOperator                 User? @relation("AssetCurrentOperator", fields: [currentOperatorId], references: [id])
  lastOperator                    User? @relation("AssetLastOperator", fields: [lastOperatorId], references: [id])
  createdBy                       User @relation("AssetCreatedBy", fields: [createdById], references: [id])
  updatedBy                       User @relation("AssetUpdatedBy", fields: [updatedById], references: [id])
  deletedBy                       User? @relation("AssetDeletedBy", fields: [deletedById], references: [id])
  
  // One-to-many relationships
  locationHistory                 LocationHistory[]
  usageLogs                       UsageLog[]
  maintenanceHistory              MaintenanceHistory[]
  complianceEvents                ComplianceEvent[]
  alertHistory                    AlertHistory[]
  assignmentHistory               AssignmentHistory[]
  transferHistory                 TransferHistory[]
  predictiveScoreHistory          PredictiveScoreHistory[]
  iotSensorReadings               IoTSensorReading[]
  mediaAttachments                MediaAttachment[]
  assetRelationshipsParent        AssetRelationship[] @relation("ParentAsset")
  assetRelationshipsChild         AssetRelationship[] @relation("ChildAsset")
  trainingRecords                 TrainingRecord[]
  telemetryIngestEvents           TelemetryIngestEvent[]
  scanLogs                        AssetScanLog[]

  @@index([organizationId])
  @@index([assetTagNumber])
  @@index([serialNumber])
  @@index([currentFacilityId])
  @@index([currentRoomId])
  @@index([assetStatus])
  @@index([deviceCategory])
  @@index([lastSeenTimestamp])
  @@index([nextPmDueDate])
  @@index([nextCalibrationDue])
  @@index([deletedAt])
  @@index([primaryCustodianId])
  @@index([custodianDepartmentId])
  @@index([assetStatus, criticalityLevel])
  @@index([currentFacilityId, assetStatus])
  @@map("assets")
}

// =====================================================
// TIME-SERIES MODELS (TimescaleDB Hypertables)
// =====================================================

model LocationHistory {
  id                  String          @id @default(cuid())
  assetId             String
  timestamp           DateTime        @default(now())
  facilityId          String?
  buildingId          String?
  floorId             String?
  roomId              String?
  zone                String?
  coordinatesX        Decimal?        @db.Decimal(10, 4)
  coordinatesY        Decimal?        @db.Decimal(10, 4)
  coordinatesZ        Decimal?        @db.Decimal(10, 4)
  accuracyMeters      Decimal?        @db.Decimal(4, 2)
  isMoving            Boolean?
  signalStrength      Int?
  trackingMethod      TrackingMethod
  recordedByUserId    String?

  asset               Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  facility            Facility?       @relation(fields: [facilityId], references: [id])
  building            Building?       @relation(fields: [buildingId], references: [id])
  floor               Floor?          @relation(fields: [floorId], references: [id])
  room                Room?           @relation(fields: [roomId], references: [id])
  recordedByUser      User?           @relation(fields: [recordedByUserId], references: [id])

  @@index([assetId, timestamp(sort: Desc)])
  @@index([roomId, timestamp(sort: Desc)])
  @@index([timestamp])
  @@map("location_history")
}

model UsageLog {
  id                  String          @id @default(cuid())
  assetId             String
  sessionStartTime    DateTime
  sessionEndTime      DateTime?
  durationMinutes     Decimal?        @db.Decimal(8, 2)
  operatorId          String?
  departmentId        String?
  patientId           String?
  procedureCode       String?
  usageCycles         Int             @default(1)
  notes               String?

  asset               Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  operator            User?           @relation(fields: [operatorId], references: [id])
  department          Department?     @relation(fields: [departmentId], references: [id])

  @@index([assetId, sessionStartTime(sort: Desc)])
  @@index([operatorId, sessionStartTime(sort: Desc)])
  @@index([sessionStartTime])
  @@map("usage_logs")
}

model IoTSensorReading {
  id                  String          @id @default(cuid())
  assetId             String
  sensorId            String
  timestamp           DateTime        @default(now())
  sensorType          String
  value               Decimal         @db.Decimal(12, 4)
  unit                String?
  status              String?

  asset               Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([sensorId, timestamp(sort: Desc)])
  @@index([assetId, timestamp(sort: Desc)])
  @@index([timestamp])
  @@map("iot_sensor_readings")
}

model PredictiveScoreHistory {
  id                      String          @id @default(cuid())
  assetId                 String
  timestamp               DateTime        @default(now())
  failureProbabilityScore Decimal         @db.Decimal(5, 2)
  predictedFailureDate    DateTime?
  failureCategory         FailureCategory?
  mlModelVersion          String
  confidenceScore         Decimal?        @db.Decimal(5, 2)
  contributingFactors     Json?

  asset                   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, timestamp(sort: Desc)])
  @@index([timestamp])
  @@map("predictive_scores_history")
}

// =====================================================
// MAINTENANCE & WORK ORDERS
// =====================================================

model MaintenanceHistory {
  id                      String          @id @default(uuid())
  assetId                 String
  workOrderType           WorkOrderType
  workOrderStatus         WorkOrderStatus @default(PENDING)
  scheduledDate           DateTime
  startedAt               DateTime?
  completedAt             DateTime?
  actualDurationHours     Decimal?        @db.Decimal(6, 2)
  assignedTechnicianId    String?
  vendorId                String?
  description             String?
  workPerformed           String?
  partsUsed               Json?
  laborCost               Decimal?        @db.Decimal(10, 2)
  partsCost               Decimal?        @db.Decimal(10, 2)
  totalCost               Decimal?        @db.Decimal(10, 2)
  downtimeHours           Decimal?        @db.Decimal(6, 2)
  isEmergency             Boolean         @default(false)
  failureCategory         FailureCategory?
  rootCauseAnalysis       String?
  correctiveActions       String?
  followupRequired        Boolean         @default(false)
  followupDueDate         DateTime?
  attachments             Json?
  createdAt               DateTime        @default(now())
  createdByUserId         String
  updatedAt               DateTime        @updatedAt

  asset                   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assignedTechnician      User?           @relation("MaintenanceAssignedTechnician", fields: [assignedTechnicianId], references: [id])
  vendor                  Vendor?         @relation(fields: [vendorId], references: [id])
  createdBy               User            @relation("MaintenanceCreatedBy", fields: [createdByUserId], references: [id])

  @@index([assetId, scheduledDate(sort: Desc)])
  @@index([workOrderStatus])
  @@index([assignedTechnicianId])
  @@map("maintenance_history")
}

model SparePart {
  id                      String          @id @default(uuid())
  partNumber              String          @unique
  partName                String
  manufacturer            String?
  compatibleAssetModels   Json?
  unitCost                Decimal         @db.Decimal(10, 2)
  quantityInStock         Int             @default(0)
  minimumStockLevel       Int             @default(0)
  reorderQuantity         Int?
  supplierId              String?
  location                String?
  leadTimeDays            Int?
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  supplier                Vendor?         @relation(fields: [supplierId], references: [id])

  @@map("spare_parts")
}

// =====================================================
// COMPLIANCE & REGULATORY
// =====================================================

model ComplianceEvent {
  id                          String          @id @default(uuid())
  assetId                     String
  eventType                   String
  eventDate                   DateTime
  inspectorName               String?
  inspectorOrganization       String?
  certificationNumber         String?
  certificationExpiryDate     DateTime?
  result                      String?
  findings                    String?
  correctiveActionsRequired   String?
  correctiveActionsCompleted  Boolean         @default(false)
  attachments                 Json?
  createdAt                   DateTime        @default(now())
  createdByUserId             String

  asset                       Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  createdBy                   User            @relation(fields: [createdByUserId], references: [id])

  @@index([assetId, eventDate(sort: Desc)])
  @@map("compliance_events")
}

// =====================================================
// ALERTS & NOTIFICATIONS
// =====================================================

model AlertHistory {
  id                      String          @id @default(uuid())
  assetId                 String?
  alertType               String
  severity                AlertSeverity
  title                   String
  message                 String
  triggeredAt             DateTime        @default(now())
  acknowledgedAt          DateTime?
  acknowledgedByUserId    String?
  resolvedAt              DateTime?
  resolvedByUserId        String?
  resolutionNotes         String?
  escalated               Boolean         @default(false)
  escalatedAt             DateTime?
  escalatedToUserId       String?
  notificationSent        Boolean         @default(false)
  notificationMethod      String?
  metadata                Json?

  asset                   Asset?          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  acknowledgedBy          User?           @relation("AlertAcknowledgedBy", fields: [acknowledgedByUserId], references: [id])
  resolvedBy              User?           @relation("AlertResolvedBy", fields: [resolvedByUserId], references: [id])
  escalatedTo             User?           @relation("AlertEscalatedTo", fields: [escalatedToUserId], references: [id])

  @@index([assetId, triggeredAt(sort: Desc)])
  @@index([triggeredAt(sort: Desc)])
  @@index([severity, triggeredAt(sort: Desc)])
  @@map("alert_history")
}

// =====================================================
// USER MANAGEMENT & CUSTODY
// =====================================================

model AssignmentHistory {
  id                      String          @id @default(uuid())
  assetId                 String
  assignedToUserId        String?
  assignedToDepartmentId  String?
  assignedByUserId        String
  assignmentStartTime     DateTime        @default(now())
  assignmentEndTime       DateTime?
  assignmentPurpose       String?
  locationAtAssignment    String?
  notes                   String?

  asset                   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  assignedToUser          User?           @relation("AssignedTo", fields: [assignedToUserId], references: [id])
  assignedToDepartment    Department?     @relation(fields: [assignedToDepartmentId], references: [id])
  assignedBy              User            @relation("AssignedBy", fields: [assignedByUserId], references: [id])
  locationAtAssignmentRoom Room?          @relation(fields: [locationAtAssignment], references: [id])

  @@index([assetId, assignmentStartTime(sort: Desc)])
  @@map("assignment_history")
}

model TransferHistory {
  id                      String          @id @default(uuid())
  assetId                 String
  fromFacilityId          String?
  toFacilityId            String
  fromRoomId              String?
  toRoomId                String?
  transferDate            DateTime        @default(now())
  initiatedByUserId       String
  approvedByUserId        String?
  transferReason          String?
  conditionAtTransfer     String?
  receivedByUserId        String?
  receivedAt              DateTime?
  notes                   String?

  asset                   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)
  fromFacility            Facility?       @relation("TransferFrom", fields: [fromFacilityId], references: [id])
  toFacility              Facility        @relation("TransferTo", fields: [toFacilityId], references: [id])
  fromRoom                Room?           @relation("TransferFromRoom", fields: [fromRoomId], references: [id])
  toRoom                  Room?           @relation("TransferToRoom", fields: [toRoomId], references: [id])
  initiatedBy             User            @relation("TransferInitiated", fields: [initiatedByUserId], references: [id])
  approvedBy              User?           @relation("TransferApproved", fields: [approvedByUserId], references: [id])
  receivedBy              User?           @relation("TransferReceived", fields: [receivedByUserId], references: [id])

  @@index([assetId, transferDate(sort: Desc)])
  @@map("transfer_history")
}

model TrainingRecord {
  id                      String          @id @default(uuid())
  assetId                 String?
  userId                  String
  trainingDate            DateTime
  trainerName             String?
  trainingType            String?
  certificationIssued     Boolean         @default(false)
  certificationNumber     String?
  certificationExpiryDate DateTime?
  hoursCompleted          Decimal?        @db.Decimal(4, 1)
  assessmentScore         Decimal?        @db.Decimal(5, 2)
  assessmentPassed        Boolean?
  attachments             Json?
  createdAt               DateTime        @default(now())

  asset                   Asset?          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  user                    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([assetId, trainingDate(sort: Desc)])
  @@index([userId, trainingDate(sort: Desc)])
  @@map("training_records")
}

// =====================================================
// ASSET RELATIONSHIPS
// =====================================================

model AssetRelationship {
  id                      String          @id @default(uuid())
  parentAssetId           String
  childAssetId            String
  relationshipType        String
  isMandatory             Boolean         @default(false)
  quantity                Int             @default(1)
  notes                   String?
  createdAt               DateTime        @default(now())

  parentAsset             Asset           @relation("ParentAsset", fields: [parentAssetId], references: [id], onDelete: Cascade)
  childAsset              Asset           @relation("ChildAsset", fields: [childAssetId], references: [id], onDelete: Cascade)

  @@unique([parentAssetId, childAssetId, relationshipType])
  @@map("asset_relationships")
}

// =====================================================
// MEDIA & ATTACHMENTS
// =====================================================

model MediaAttachment {
  id                      String          @id @default(uuid())
  assetId                 String?
  fileName                String
  fileType                String
  fileSizeBytes           BigInt?
  storageUrl              String
  storagePath             String?
  thumbnailUrl            String?
  category                String?
  description             String?
  uploadedByUserId        String?
  uploadedAt              DateTime        @default(now())

  asset                   Asset?          @relation(fields: [assetId], references: [id], onDelete: Cascade)
  uploadedBy              User?           @relation(fields: [uploadedByUserId], references: [id])

  @@index([assetId])
  @@map("media_attachments")
}

// =====================================================
// ML MODEL REGISTRY
// =====================================================

model MLModel {
  id                      String          @id @default(uuid())
  modelName               String          @unique
  modelVersion            String
  modelType               String?
  trainingDate            DateTime
  accuracyScore           Decimal?        @db.Decimal(5, 4)
  precisionScore          Decimal?        @db.Decimal(5, 4)
  recallScore             Decimal?        @db.Decimal(5, 4)
  f1Score                 Decimal?        @db.Decimal(5, 4)
  hyperparameters         Json?
  featureList             Json?
  modelFilePath           String?
  isActive                Boolean         @default(true)
  createdAt               DateTime        @default(now())

  @@unique([modelName, modelVersion])
  @@map("ml_models")
}

// =====================================================
// LEGACY COMPATIBILITY MODELS
// =====================================================

model TelemetryIngestEvent {
  id                      String          @id @default(uuid())
  assetId                 String?
  deviceId                String
  payload                 Json            @map("rawPayload")
  receivedAt              DateTime        @default(now())
  processedAt             DateTime?
  status                  String          @default("pending")

  asset                   Asset?          @relation(fields: [assetId], references: [id], onDelete: SetNull)

  @@index([deviceId, receivedAt])
  @@index([status])
  @@map("telemetry_ingest_events")
}

model AssetScanLog {
  id                      String          @id @default(uuid())
  assetId                 String
  qrPayload               String
  notes                   String?
  locationHint            String?
  createdAt               DateTime        @default(now())

  asset                   Asset           @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId, createdAt])
  @@map("asset_scan_logs")
}

